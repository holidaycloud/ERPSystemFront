<div class="row">
    <div class="col-xs-12 col-sm-7 col-md-7 col-lg-4">
        <h1 class="page-title txt-color-blueDark"><i class="fa-fw fa fa-money"></i> 价格库存管理 <span>>价格库存维护</span></h1>
    </div>
</div>
<div class="row">
    <form id="piiForm" class="smart-form">
        <fieldset>
            <section>
                <div class="row">
                    <label class="label col col-2">产品名称</label>
                    <div class="col col-8">
                        <select style="width:100%;"  name="piiPName" id="piiPName" placeholder="必填">
                            <optgroup label="产品列表" id="selectPdts">

                            </optgroup>
                        </select>
                    </div>
                </div>
            </section>
            <section>
                <div class="row">
                    <label class="label col col-2">有效期</label>
                    <div class="col col-4">
                        <div class="input-group">
                            <input type="text" name="piiStDate" id="piiStDate" placeholder="选择开始时间" class="form-control datepicker" data-dateformat="yy-mm-dd">
                            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                        </div>
                    </div>
                    <div class="col col-4">
                        <div class="input-group">
                            <input type="text" name="piiEndDate" id="piiEndDate" placeholder="选择结束时间" class="form-control datepicker" data-dateformat="yy-mm-dd">
                            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                        </div>
                    </div>
                </div>
            </section>
            <section>
                <div class="col col-10"></div>
                <div class="col col-2">
                    <button type="button" class="btn btn-primary btn-lg" id="btnPiSearch">
                        搜索
                    </button>
                </div>
            </section>
        </fieldset>
    </form>
</div>
<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <!-- Widget ID (each widget will need unique ID)-->
        <div class="jarviswidget jarviswidget-color-blueDark" id="tblEnt" data-widget-custombutton="true">
            <!-- widget options:
            usage: <div class="jarviswidget" id="wid-id-0" data-widget-editbutton="false">

            data-widget-colorbutton="false"
            data-widget-editbutton="false"
            data-widget-togglebutton="false"
            data-widget-deletebutton="false"
            data-widget-fullscreenbutton="false"
            data-widget-custombutton="false"
            data-widget-collapsed="true"
            data-widget-sortable="false"

            -->
            <header>
                <span class="widget-icon"> <i class="fa fa-calendar"></i> </span>
                <h2>价格库存维护</h2>
            </header>

            <!-- widget div-->
            <div>
                <!-- end widget edit box -->

                <!-- widget content -->
                <div class="widget-body">
                    <div id="myCal"></div>
                </div>
                <!-- end widget content -->

            </div>
            <!-- end widget div -->

        </div>
    </div>
</div>

<script type="text/javascript">
    //load page
    var selectedPdt = "";
    $("#ldModal").modal({
        backdrop:false,
        keyboard:false
    });
    $.ajax({
        type: "GET",
        url: "/pi/getPdts",
        cache:false
    }).done(function(data, textStatus){
                var h = "";
                for(var e in data.data){
                    h +="<option value="+data.data[e]._id+" data-std="+data.data[e].startDate+" data-edd="+data.data[e].endDate+">"+data.data[e].name+"</option>";
                }
                $("#selectPdts").html(h);

                $("#ldModal").modal("hide");
            }).fail(function(){
                $("#ldModal").modal("hide");
                alert("网络异常，请重试！");
            });

    $("#piiPName").select2({
        placeholder: "请选择产品",
        allowClear: true,
        formatSelection: formatSelect2
    });

    //onselect product
    function formatSelect2(e){
        selectedPdt = e.id;
        var d = $(e.element);
        var st = new Date(d.data('std'));
        var ed = new Date(d.data('edd'));
        $("#piiStDate").datepicker("option", "minDate", st);
        $("#piiStDate").datepicker("option", "maxDate", ed);
        $("#piiStDate").datepicker('setDate',st);
        $("#piiEndDate").datepicker("option", "minDate", st);
        $("#piiEndDate").datepicker("option", "maxDate", ed);
        $("#piiEndDate").datepicker('setDate',ed);
        return e.text;
    }

    $("#piiStDate").datepicker({
        defaultDate: "+0d",
        changeMonth: false,
        changeYear: false,
        numberOfMonths: 1,
        prevText: '<i class="fa fa-chevron-left"></i>',
        nextText: '<i class="fa fa-chevron-right"></i>',
        onClose: function (selectedDate) {
            var arrays = selectedDate.split('-');
            var mDate = new Date(arrays[0],(arrays[1]-1),arrays[2]);
//            mDate.setDate(mDate.getDate()+1);
            $("#piiEndDate").datepicker("option", "minDate", mDate);
        }

    });
    $("#piiStDate").datepicker('setDate',"+0d");
    $("#piiEndDate").datepicker({
        defaultDate: "+0d",
        changeMonth: false,
        changeYear: false,
        numberOfMonths:1,
        prevText: '<i class="fa fa-chevron-left"></i>',
        nextText: '<i class="fa fa-chevron-right"></i>'
    });
    $("#piiEndDate").datepicker('setDate',"+0d");

    //save input data
    $("#btnPiSearch").click(function(e){
        e.preventDefault();
        if(!selectedPdt||selectedPdt.trim()===""){
            alert("请选择需要录入价格库存的产品！");
            return false;
        }
        if($("#piiStDate").val()===""){
            alert("请选择开始时间！");
            return false;
        }
        if($("#piiEndDate").val()===""){
            alert("请选择结束时间！");
            return false;
        }
        $("#myCal").fullCalendar('refetchEvents');
    });

    //init calendar
    $("#myCal").fullCalendar({
        aspectRatio:3,
        header: {
                     left: 'prev,next today',
                     center: 'title',
                     right:''
                 },

                 monthNames: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"],
                 monthNamesShort: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"],
                 dayNames: ["周日", "周一", "周二", "周三", "周四", "周五", "周六"],
                 dayNamesShort: ["周日", "周一", "周二", "周三", "周四", "周五", "周六"],
                 today: ["今天"],
                 firstDay: 1,
                 buttonText: {
                 today: '本月',
                    month: '月',
                    week: '周',
                    day: '日',
                    prev: '上一月',
                    next: '下一月'
                 },
        editable: false,
        droppable: false,
        allDay:true,
//        dayClick: function (date, allDay, jsEvent, view) {
//        },
        eventRender: function(event, element) {
            element.find('.fc-event-title').append("<br/><span class='ultra-light'>" + event.description +
                    "</span>").css("cursor","pointer");
        },
        eventClick: function(calEvent, jsEvent, view) {
            clearPIUModal();
            $("#piuId").val(calEvent.id);
            var  pName = $("#piiPName").select2("data");
            $("#piuName").html(pName.text);
            $("#piuDate").html(calEvent.start.format("yyyy-MM-dd"));
            var titles = calEvent.title.split("/");
            var descs = calEvent.description.split("/");
            for(var i  in titles){
                if(titles[i]==="价格"){
                    $("#piuPrice").val(descs[i]);
                }else if(titles[i]==="库存"){
                    $("#piuInventory").val(descs[i]);
                }
            }
            $("#piModal").modal();
//            event.backgroundColor = "blue";
//            $('#myCal').fullCalendar('updateEvent', event);

        },
        events: function(start, end, callback) {
            if(selectedPdt&&selectedPdt.trim()!==""){
                var params = {};
                params.product = selectedPdt;
                params.startDate = $("#piiStDate").val();
                params.endDate = $("#piiEndDate").val();
                $.ajax({
                    type: "POST",
                    url: "/pi/list",
                    cache:false,
                    data:params
                }).done(function(data, textStatus){
                            if(data.error!=0){
                                showMessage("danger","获取数据失败！"+data.errorMsg);
                            }else{
                                callback(data.data);
                            }
                        }).fail(function(){
                            alert("网络异常，请重试！");
                        });
            }
        },
        windowResize: function (event, ui) {
            $('#myCal').fullCalendar('render');
        }
    });

    //clear modal
    function clearPIUModal(){
        $("#piuId").val("");
        $("#piuName").val("");
        $("#piuDate").val("");
        $("#piuPrice").val("");
        $("#piuInventory").val("");
    }
    //modal update
    $("#btnPiuUpdate").click(function(e){
        e.preventDefault();
        if(""===$("#piuPrice").val().trim()){
            alert("价格不能为空！");
            return false;
        }
        if(""===$("#piuInventory").val().trim()){
            alert("库存不能为空！");
            return false;
        }
        if(""!==$("#piuPrice").val().trim()&&isNaN($("#piuPrice").val().trim())){
            alert("请填写正确的价格！");
            return false;
        }
        if(""!==$("#piuInventory").val().trim()&&isNaN($("#piuInventory").val().trim())){
            alert("请填写正确的库存数！");
            return false;
        }
        var params = {};
        if(""!==$("#piuPrice").val().trim()){
            params.price = $("#piuPrice").val();
        }
        if(""!==$("#piuInventory").val().trim()){
            params.inventory = $("#piuInventory").val();
        }

        $.ajax({
            type: "POST",
            url: "/pi/update/"+$("#piuId").val(),
            cache:false,
            data:params
        }).done(function(data, textStatus){
                    if(data.error!=0){
                        showMessage("danger","修改价格失败！"+data.errorMsg);
                    }else{
                        $("#myCal").fullCalendar('refetchEvents');
                        showMessage("success","修改价格成功！");
                    }
                    $("#piModal").modal('hide');
                }).fail(function(){
                    alert("网络异常，请重试！");
                });
    });
</script>